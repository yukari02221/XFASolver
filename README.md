# XFASolver - リスク最適化Solver

XFASolverは、証券プロップファームの評価プログラムにおいて、リスク制約下での最適なベット戦略を計算するRustベースのソルバーです。ベルマン方程式による累積期待利得（割引現在価値）の最適価値関数を計算し、各状態における最適ベット戦略を導出します。

## 概要

評価プログラムでは、トレーダーは厳格なリスク制約の下で取引を行う必要があります。XFASolverは以下の制約条件を考慮して最適なベット額を計算します：

- 最大ドローダウン制限
- 規定額超過日数制限（5日間）
- タイムリミット（10ターン）
- 資金管理ルール

## 数理最適化モデル

### 問題設定

#### 評価プログラムの制約
- 評価期間：最大2週間（1週目10ターン + 2週目継続可能）
- RR比：2:1（勝利時利益 = ベット額 × 2、敗北時損失 = ベット額）
- 勝率：$p = 1/3$、負率：$1-p = 2/3$
- 期待値：$(1/3) \times 2 + (2/3) \times (-1) = 0$（フェアゲーム）
- 最小ベット額：$50、最大ベット額：$4000（50ドル刻み）

#### 状態空間の定義
システムの状態は5次元ベクトルで表現される：
```math
\mathbf{s} = (s, h, d, t, r) \in \mathcal{S}
```

where:
- $s \in \mathbb{Z}$：現在の口座残高
- $h \in \mathbb{Z}$：最高到達残高
- $d \in \{0, 1, 2, 3, 4\}$：規定額超過日数（$200以上勝利した日数）
- $t \in \{0, 1, 2, ..., 9\}$：経過ターン数
- $r \in \{0, 1\}$：週フラグ（0: 1週目、1: 2週目以降）

#### 失効条件（Terminal States）
口座失効の判定関数：

```math
\text{Failed}(s, h, r) = \begin{cases}
s \leq 0 & \text{if } r = 1 \text{ (2週目)} \\
s < h - 2000 & \text{if } r = 0 \text{ and } h \leq 2000 \\
s \leq 0 & \text{if } r = 0 \text{ and } h > 2000
\end{cases}
```

#### 規定額超過による強制出金
$d = 5$に達した場合の状態遷移：
- 出金額：$0.5s$
- 残高更新：$s' = s/2$
- 継続条件：$s' \geq 100$
- 週フラグ更新：$r' = 1$（2週目へ移行）
- パラメータリセット：$d' = 0, t' = 0, h' = s'$

### ベルマン方程式による最適化

#### 価値関数の定義
各状態における累積期待利得の最適価値関数：
```math
V^*(s, h, d, t, r) = \max_{w \in \mathcal{W}(s,h,d,t,r)} \mathbb{E}[R + \gamma \cdot V^*(s', h', d', t+1, r')]
```

#### 行動制約集合
実行可能ベット額の集合：
```math
\mathcal{W}(s, h, d, t, r) = \{w \in \{50, 100, ..., 4000\} : w \leq \min(\text{MaxDD}(s,h,r) - \text{CurrentDD}(s,h), s)\}
```

#### 最大ドローダウン制約
```math
\text{MaxDD}(s, h, r) = \begin{cases}
h & \text{if } r = 1 \text{ (2週目)} \\
2000 & \text{if } r = 0 \text{ and } h \leq 2000 \\
h & \text{if } r = 0 \text{ and } h > 2000
\end{cases}
```

```math
\text{CurrentDD}(s, h) = \max(h - s, 0)
```

#### 時間割引因子
```math
\gamma = 0.985
```

この割引因子は：
- 早期終了に対するインセンティブを提供
- モデルが必ず10ターン使い切ることを防ぐ
- 時間経過に伴うリスクを反映

### 状態遷移ダイナミクス

#### 勝利時の状態遷移（確率 $p = 1/3$）
- 残高更新：$s' = s + 2w$
- MLL更新：$h' = \max(h, s')$
- 規定額超過日数：$d' = d + \mathbf{1}_{2w \geq 200}$
- ターン更新：$t' = t + 1$
- 即座報酬：$R = 0$

#### 敗北時の状態遷移（確率 $1-p = 2/3$）
- 残高更新：$s' = s - w$
- MLL維持：$h' = h$
- 規定額超過日数維持：$d' = d$
- ターン更新：$t' = t + 1$
- 即座報酬：$R = 0$

#### 境界条件
1. **規定額超過時** ($d = 5$):
   ```math
   V^*(s, h, 5, t, r) = 0.5s + V^*(s/2, s/2, 0, 0, 1) \quad \text{if } s/2 \geq 100
   ```
   ```math
   V^*(s, h, 5, t, r) = 0.5s \quad \text{if } s/2 < 100
   ```

2. **時間切れ** ($t = 10$):
   ```math
   V^*(s, h, d, 10, r) = 0
   ```

3. **失効状態**:
   ```math
   V^*(s, h, d, t, r) = 0 \quad \text{if } \text{Failed}(s, h, r) = \text{true}
   ```

### 最適政策の導出

#### 政策関数
最適ベット額を決定する政策：
```math
\pi^*(s, h, d, t, r) = \arg\max_{w \in \mathcal{W}(s,h,d,t,r)} \mathbb{E}[V^*(s', h', d', t+1, r')]
```

#### 期待価値の計算
```math
\mathbb{E}[V^*(s', h', d', t+1, r')] = \frac{1}{3} V^*(s+2w, \max(h, s+2w), d+\mathbf{1}_{2w \geq 200}, t+1, r) + \frac{2}{3} \gamma \cdot V^*(s-w, h, d, t+1, r)
```

## 技術仕様

### アルゴリズム
#### 動的プログラミング実装
1. **メモ化**: `HashMap<State, (f64, i32)>`によるTop-down DP
2. **状態探索**: 各状態で全実行可能行動を評価
3. **最適選択**: 期待価値最大化によるベット額決定

#### アルゴリズムの特徴
1. **完全情報**: 全ての制約条件を考慮
2. **最適性**: ベルマン最適性条件を満たす
3. **効率性**: メモ化による重複計算の回避

### 制約条件
- ベット額: $50 ≤ w ≤ $4000 (50ドル刻み)
- 最小リスク: 50ドル以上の許容ドローダウンが必要
- ターン制限: 最大10ターン
- 日数制限: 規定額超過は最大5日間

## 使用方法

### 前提条件
- Rust 2024 Edition以降
- proconioクレート（入力処理用）

### インストールと実行

```bash
# リポジトリをクローン
git clone https://github.com/username/XFASolver.git
cd XFASolver

# コンパイルと実行
cargo run
```

#### クロスコンパイル（Windows向け）
Linux/WSL環境からWindows用バイナリをビルドする場合：

```bash
# Windows 64bit用ターゲットを追加
rustup target add x86_64-pc-windows-gnu

# Windows用バイナリをビルド
cargo build --target x86_64-pc-windows-gnu --release
```

### 入力形式

プログラム実行時に以下の値を入力してください：

```
口座残高(s) MLL(h) 規定額超過日数(d) ターン数(t)
```

## テスト

単体テストを実行：

```bash
cargo test
```

テストケース：
- 最大ドローダウン計算の検証
- 1週目/2週目での制約違いの確認
- 失効条件の正確性検証

## パラメータ調整

### 定数設定

```rust
const T: u8 = 10;                    // 最大ターン数
const DISCOUNT_FACTOR: f64 = 0.985;  // 割引因子
```

### 勝率とペイアウト
- 勝率: 33.33% (1/3)
- 勝利時利益: ベット額の2倍
- 敗北時損失: ベット額

## 数値例

### 典型的なケース
初期状態: $(s=5000, h=5000, d=2, t=3, r=0)$

- 最大許容ドローダウン: $5000$
- 現在のドローダウン: $0$
- 残り許容リスク: $5000$
- 最適ベット額: モデルにより動的決定

この数理モデルは、制約付き確率的動的最適化問題として定式化され、ベルマン方程式の解として最適戦略を導出する。

## ライセンス

MIT License

## 貢献

バグ報告や機能改善の提案はIssueまでお願いします。

## 注意事項

このソフトウェアは教育・研究目的で作成されています。実際の取引での使用は自己責任でお願いします。
